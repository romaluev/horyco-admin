# Admin Panel — Business Signup & Authentication

This document explains the complete business signup process for new restaurant owners, including phone verification with OTP, account creation, and initial authentication.

---

## Table of Contents

1. [Overview](#overview)
2. [Registration Paths](#registration-paths)
3. [Self-Registration Flow (OTP)](#self-registration-flow-otp)
4. [Waitlist Approval Flow (Magic Link)](#waitlist-approval-flow-magic-link)
5. [Account Creation](#account-creation)
6. [Login Flow](#login-flow)
7. [PIN Authentication (POS)](#pin-authentication-pos)
8. [API Endpoints](#api-endpoints)
9. [Data Schemas](#data-schemas)

---

## Overview

### Purpose

The signup system allows new restaurant owners to:
- Self-register without sales team involvement (OTP path)
- OR submit waitlist application and receive magic link after approval
- Verify their phone number
- Create a tenant (restaurant brand) and their first branch
- Get immediate access to the admin panel
- Start configuring their restaurant through the onboarding wizard

### Hybrid Registration System

Horyco supports two registration paths:

| Path | Approval | Access | Use Case |
|------|----------|--------|----------|
| **Self-Registration (OTP)** | Automatic | Immediate | Open registration, startups |
| **Waitlist + Magic Link** | Super Admin | After approval | Controlled growth, enterprise |

### Security Features

**Phone Verification**:
- SMS OTP sent via Eskiz SMS provider
- 6-digit code valid for 5 minutes
- Maximum 3 verification attempts
- Rate limiting: 3 OTP requests per hour per phone
- Temporary block after max attempts exceeded

**Magic Link Invitations**:
- Token hashed with bcrypt before storage
- 7-day expiry period
- Multi-use until password is set
- Can be resent/regenerated by super admin

---

## Registration Paths

### Path A: Self-Registration (OTP)

```
1. Landing Page
   |
2. Enter Phone Number & Business Name
   | (API: POST /auth/register/request-otp)
3. SMS Sent -> Wait for OTP
   |
4. Enter OTP Code
   | (API: POST /auth/register/verify-otp)
5. Phone Verified
   |
6. Complete Profile Form
   | (API: POST /auth/register/complete)
7. Account Created (status: TRIAL, 14 days)
   |
8. Redirect to Onboarding Wizard
```

### Path B: Waitlist + Magic Link

```
1. Submit Waitlist Application
   | (API: POST /super-admin/waitlist)
2. Application in PENDING status
   |
3. Super Admin Reviews & Approves
   | (API: POST /super-admin/waitlist/:id/approve)
4. Magic Link Generated
   |
5. Owner receives link (SMS/Email/Telegram/WhatsApp)
   |
6. Owner clicks link -> Set Password page
   | (API: POST /auth/invite/verify)
7. Owner sets password
   | (API: POST /auth/invite/complete)
8. Account Created (status: TRIAL, 14 days)
   |
9. Redirect to Onboarding Wizard
```

### What Gets Created During Signup

When a user completes signup (either path), the system automatically creates:

1. **Tenant** (Restaurant Brand)
   - Unique tenant ID
   - Business name
   - Status: `TRIAL` (14-day trial period)
   - `trialEndsAt` timestamp

2. **Owner Employee**
   - First user account
   - `isOwner: true` flag (marks as tenant owner)
   - Wildcard permission (`*`) for full access
   - Can login to admin panel

3. **Default Branch**
   - Named "Main Branch" (can be changed during onboarding)
   - Owner assigned to this branch

4. **Default Roles** (4 system roles)
   - Admin, Manager, Cashier, Waiter
   - (Permission templates, not assigned to owner)

5. **Default Settings**
   - Timezone: Asia/Tashkent
   - Currency: UZS
   - Language: uz

6. **Onboarding Progress**
   - Initialized at `business_identity` step
   - Tracks completion of setup wizard

### Permission System (Important!)

**Horyco uses per-branch permissions, NOT role-based access:**

- Owner gets `isOwner: true` flag on Employee record
- Owner is assigned wildcard permission (`*`) at their branch
- This grants full access to all features
- Staff members get specific permissions per branch
- See [Staff Management](./ADMIN_STAFF_MANAGEMENT.md) for details

---

## Self-Registration Flow (OTP)

### Step 1: Request OTP

**User Journey**:
```
1. User enters phone number: +998 90 123 45 67
2. User enters business name: "Samarkand Restaurant"
3. User clicks "Send Code"
4. System sends SMS with 6-digit code
5. User receives SMS: "Your Horyco verification code: 123456"
```

**UI Form**:
```
+--------------------------------------------------+
|                                                   |
|         Welcome to Horyco!                        |
|                                                   |
|  Let's get your restaurant online in minutes     |
|                                                   |
|  Phone Number *                                   |
|  [+998] [90 123 45 67                       ]    |
|  We'll send a verification code via SMS          |
|                                                   |
|  Business Name *                                  |
|  [Samarkand Restaurant                      ]    |
|                                                   |
|  [Send Verification Code]                        |
|                                                   |
|  Already have an account? [Login]                |
|                                                   |
+--------------------------------------------------+
```

**API Call**:
```
POST /auth/register/request-otp
Content-Type: application/json
```

**Request Body:**
```json
{
  "phone": "+998901234567",
  "businessName": "Samarkand Restaurant"
}
```

**Response 200:**
```json
{
  "success": true,
  "message": "OTP sent successfully",
  "phone": "+998901234567",
  "expiresAt": "2025-01-15T10:35:00Z"
}
```

**Error 429 (Rate Limited):**
```json
{
  "statusCode": 429,
  "message": "Too many OTP requests. Please try again later."
}
```

**Phone Number Format**:
- Must start with +998 (Uzbekistan country code)
- Format: +998XXXXXXXXX (total 13 characters)
- Example: +998901234567

### Step 2: Verify OTP Code

**UI Form**:
```
+--------------------------------------------------+
|                                                   |
|         Enter Verification Code                  |
|                                                   |
|  We sent a 6-digit code to                       |
|  +998 90 123 45 67                               |
|                                                   |
|         [1] [2] [3] [4] [5] [6]                  |
|                                                   |
|  Code expires in: 04:23                          |
|                                                   |
|  [Verify]                                        |
|                                                   |
|  Didn't receive code?                            |
|  [Resend Code] (available in 52 seconds)         |
|                                                   |
+--------------------------------------------------+
```

**API Call**:
```
POST /auth/register/verify-otp
Content-Type: application/json
```

**Request Body:**
```json
{
  "phone": "+998901234567",
  "code": "123456"
}
```

**Response 200:**
```json
{
  "success": true,
  "verified": true,
  "phone": "+998901234567",
  "message": "OTP verified successfully"
}
```

**Error 400 (Invalid Code):**
```json
{
  "statusCode": 400,
  "message": "Invalid or expired OTP code"
}
```

**Error 429 (Max Attempts):**
```json
{
  "statusCode": 429,
  "message": "Too many verification attempts. Please request a new code."
}
```

### Step 3: Resend OTP (If Needed)

**API Call**:
```
POST /auth/register/resend-otp
Content-Type: application/json
```

**Request Body:**
```json
{
  "phone": "+998901234567"
}
```

**Response 200:**
```json
{
  "success": true,
  "message": "OTP sent successfully",
  "phone": "+998901234567",
  "expiresAt": "2025-01-15T10:40:00Z"
}
```

---

## Waitlist Approval Flow (Magic Link)

This flow is used when businesses apply via waitlist and are approved by super admin.

### Step 1: Verify Invitation Token

When owner clicks the magic link, frontend extracts the token and verifies it:

**API Call:**
```
POST /auth/invite/verify
Content-Type: application/json
```

**Request Body:**
```json
{
  "token": "abc123def456..."
}
```

**Response 200 (Valid Token):**
```json
{
  "valid": true,
  "tenantId": 123,
  "tenantName": "Samarkand Restaurant",
  "ownerPhone": "+998901234567",
  "ownerEmail": "akmal@samarkand.uz",
  "requiresPassword": true,
  "expiresAt": "2025-01-22T10:00:00Z",
  "daysRemaining": 5
}
```

**Response 200 (Invalid/Expired Token):**
```json
{
  "valid": false,
  "requiresPassword": false,
  "message": "Invalid or expired invitation token"
}
```

### Step 2: Complete Invitation (Set Password)

**UI Form:**
```
+--------------------------------------------------+
|                                                   |
|         Welcome to Horyco!                        |
|                                                   |
|  Your business "Samarkand Restaurant"             |
|  has been approved.                               |
|                                                   |
|  Phone: +998 90 123 45 67                         |
|                                                   |
|  Create your password to get started:             |
|                                                   |
|  Password *                                       |
|  [........                                  ]    |
|  At least 8 characters                           |
|                                                   |
|  Confirm Password *                               |
|  [........                                  ]    |
|                                                   |
|  [Set Password & Continue]                       |
|                                                   |
+--------------------------------------------------+
```

**API Call:**
```
POST /auth/invite/complete
Content-Type: application/json
```

**Request Body:**
```json
{
  "token": "abc123def456...",
  "password": "secure123!"
}
```

**Response 200:**
```json
{
  "success": true,
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": 456,
    "fullName": "Akmal Karimov",
    "phone": "+998901234567",
    "email": "akmal@samarkand.uz",
    "isOwner": true
  },
  "tenant": {
    "id": 123,
    "name": "Samarkand Restaurant",
    "slug": "samarkand-restaurant"
  },
  "message": "Welcome to Horyco! Your account has been set up successfully."
}
```

**Error 400 (Invalid Token):**
```json
{
  "statusCode": 400,
  "message": "Invalid or expired invitation token"
}
```

### Magic Link Behavior

**Important Notes:**
- Link is valid for **7 days** from generation
- Link can be used **multiple times** until password is set
- Once password is set, invitation is marked as `isCompleted: true`
- Super admin can regenerate/resend link if needed
- Owner can receive link via SMS, Email, Telegram, or WhatsApp (flexible delivery)

---

## Account Creation

### Complete Profile Form (Self-Registration Path)

**After OTP verified**, user fills out their profile:

**UI Form**:
```
+--------------------------------------------------+
|                                                   |
|         Complete Your Profile                     |
|                                                   |
|  Owner Information:                               |
|                                                   |
|  Full Name *                                      |
|  [Akmal Karimov                             ]    |
|                                                   |
|  Email (optional)                                 |
|  [akmal@samarkand.uz                        ]    |
|  We'll send receipts and notifications           |
|                                                   |
|  Create Password *                                |
|  [........                                  ]    |
|  At least 8 characters                           |
|                                                   |
|  Confirm Password *                               |
|  [........                                  ]    |
|                                                   |
|  [x] I agree to Terms of Service and             |
|      Privacy Policy                               |
|                                                   |
|  [Create Account]                                |
|                                                   |
+--------------------------------------------------+
```

**API Call**:
```
POST /auth/register/complete
Content-Type: application/json
```

**Request Body:**
```json
{
  "phone": "+998901234567",
  "fullName": "Akmal Karimov",
  "email": "akmal@samarkand.uz",
  "password": "secure123!",
  "businessName": "Samarkand Restaurant"
}
```

**Response 201:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
  "tokenType": "Bearer",
  "expiresIn": 900,
  "tenant": {
    "id": 123,
    "name": "Samarkand Restaurant",
    "slug": "tenant-uuid-temporary",
    "businessType": null,
    "email": "akmal@samarkand.uz",
    "phone": "+998901234567"
  },
  "employee": {
    "id": 456,
    "fullName": "Akmal Karimov",
    "phone": "+998901234567",
    "permissions": ["*"]
  },
  "message": "Registration completed successfully"
}
```

**Note:**
- `slug` is temporary (UUID format) - customized during onboarding
- `businessType` is null - set during business identity step
- `permissions: ["*"]` indicates full access (wildcard permission)

**Error 400 (Phone Not Verified):**
```json
{
  "statusCode": 400,
  "message": "Phone number not verified. Please complete OTP verification first."
}
```

**Error 409 (Already Registered):**
```json
{
  "statusCode": 409,
  "message": "Phone or email already registered"
}
```

---

## Login Flow

### Regular Login (Phone + Password)

**UI Form**:
```
+--------------------------------------------------+
|                                                   |
|         Login to Horyco                           |
|                                                   |
|  Phone Number                                     |
|  [+998] [90 123 45 67                       ]    |
|                                                   |
|  Password                                         |
|  [........                              ] [eye]  |
|                                                   |
|  [ ] Remember me                                  |
|                                                   |
|  [Login]                                         |
|                                                   |
|  [Forgot Password?]                              |
|                                                   |
|  Don't have an account? [Sign Up]                |
|                                                   |
+--------------------------------------------------+
```

**API Call**:
```
POST /auth/login
Content-Type: application/json
```

**Request Body:**
```json
{
  "phone": "+998901234567",
  "password": "secure123!",
  "tenantSlug": "samarkand-restaurant-123"
}
```

**Response 200:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
  "tokenType": "Bearer",
  "expiresIn": 900,
  "employee": {
    "id": 456,
    "phone": "+998901234567",
    "fullName": "Akmal Karimov",
    "tenantId": 123,
    "branchPermissions": {
      "10": ["*"],
      "11": ["menu:view", "orders:create"]
    }
  }
}
```

**Note:** `branchPermissions` is a map of `branchId → permission names[]`
- `"*"` means full access at that branch
- Staff may have different permissions per branch

**Error 401 (Invalid Credentials):**
```json
{
  "statusCode": 401,
  "message": "Invalid phone number or password"
}
```

### Token Refresh

**API Call**:
```
POST /auth/refresh
Content-Type: application/json
```

**Request Body:**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
}
```

**Response 200:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
  "tokenType": "Bearer",
  "expiresIn": 900
}
```

---

## PIN Authentication (POS)

### Why PIN Login?

**Problem**: Entering phone + password on POS tablet is slow
**Solution**: 4-digit PIN for fast authentication

**Use Case**:
- Manager logs in with phone + password (first time)
- Manager generates PINs for all employees
- Employees login with PIN (takes 2 seconds)
- PINs valid for 30 days, then need regeneration

### Setting Up PIN for Employee

**API Call**:
```
POST /auth/generate-pin
Authorization: Bearer {accessToken}
Content-Type: application/json
```

**Request Body:**
```json
{
  "employeeId": 456
}
```

**Response 200:**
```json
{
  "pin": "1234",
  "expiresAt": "2025-02-20T00:00:00Z",
  "employeeId": 456,
  "message": "PIN generated successfully. Please share this PIN securely with the employee."
}
```

**Important**: The PIN is only shown once. Manager must share it with employee securely.

### PIN Login Flow (POS)

**Step 1: Get employees list for branch**

```
GET /pos/staff/staff-list?branchId=10
Authorization: Bearer {accessToken}
```

**Response 200:**
```json
[
  {
    "id": 456,
    "fullName": "Akmal Karimov",
    "phone": "+998901234567",
    "hasPin": true,
    "photoUrl": "https://cdn.example.com/photos/456.jpg",
    "isActive": true,
    "isOwner": false,
    "permissions": ["menu:view", "orders:create", "orders:view"]
  },
  {
    "id": 457,
    "fullName": "Farrux Aliyev",
    "phone": "+998909876543",
    "hasPin": false,
    "photoUrl": null,
    "isActive": true,
    "isOwner": false,
    "permissions": ["menu:view", "orders:create"]
  }
]
```

**Note:** `permissions` array shows permissions for the requested branch only.

**Step 2: Login with PIN**

```
POST /auth/pin-login
Content-Type: application/json
```

**Request Body:**
```json
{
  "employeeId": 456,
  "pin": "1234",
  "branchId": 10
}
```

**Response 200:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
  "tokenType": "Bearer",
  "expiresIn": 900,
  "employee": {
    "id": 456,
    "fullName": "Akmal Karimov",
    "phone": "+998901234567",
    "tenantId": 123,
    "branchPermissions": {
      "10": ["menu:view", "orders:create", "orders:view"]
    }
  },
  "hasActiveSession": true,
  "activeSessionId": 789,
  "sessionOpenedAt": "2025-01-15T08:00:00Z"
}
```

**Note:** Response includes active payment session info if branch has one open.

**Error 401 (Invalid PIN):**
```json
{
  "statusCode": 401,
  "message": "Invalid PIN"
}
```

**Error 400 (PIN Expired):**
```json
{
  "statusCode": 400,
  "message": "PIN has expired or is not enabled. Please contact your manager."
}
```

---

## API Endpoints

### Self-Registration (OTP Flow)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/auth/register/request-otp` | POST | Request OTP code |
| `/auth/register/verify-otp` | POST | Verify OTP code |
| `/auth/register/resend-otp` | POST | Resend OTP code |
| `/auth/register/complete` | POST | Complete registration |

### Magic Link Invitation Flow

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/auth/invite/verify` | POST | Verify invitation token |
| `/auth/invite/complete` | POST | Set password and complete invitation |

### Login Flow

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/auth/login` | POST | Login with phone/password |
| `/auth/refresh` | POST | Refresh access token |
| `/auth/me` | GET | Get current user info |
| `/auth/logout` | POST | Logout |

### PIN Authentication

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/pos/staff/staff-list` | GET | Get employees for branch |
| `/auth/pin-login` | POST | Login with PIN |
| `/auth/generate-pin` | POST | Generate PIN (Admin/Manager) |
| `/auth/refresh-pin` | POST | Refresh PIN |
| `/auth/pin-status/:employeeId` | GET | Check PIN status |

---

## Data Schemas

### Request OTP

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `phone` | string | Yes | Format: +998XXXXXXXXX |
| `businessName` | string | Yes | 2-255 characters |

### Verify OTP

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `phone` | string | Yes | Format: +998XXXXXXXXX |
| `code` | string | Yes | Exactly 6 digits |

### Complete Registration

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `phone` | string | Yes | Must be verified |
| `fullName` | string | Yes | Owner's full name |
| `email` | string | Yes | Valid email format |
| `password` | string | Yes | Min 8 characters |
| `businessName` | string | No | Uses OTP request name if omitted |

### Login

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `phone` | string | Yes | Format: +998XXXXXXXXX |
| `password` | string | Yes | Min 8 characters |
| `tenantSlug` | string | No | For multi-tenant disambiguation |

### PIN Login

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `employeeId` | number | Yes | Employee ID |
| `pin` | string | Yes | 4-digit PIN |
| `branchId` | number | No | For multi-branch employees |

### Token Response

| Field | Type | Description |
|-------|------|-------------|
| `accessToken` | string | JWT access token (15 min) |
| `refreshToken` | string | JWT refresh token (7 days) |
| `tokenType` | string | Always "Bearer" |
| `expiresIn` | number | Seconds until expiry |
| `employee` | object | Employee info |
| `tenant` | object | Tenant info (signup only) |

---

## Common Questions

**Q: Why phone verification instead of email?**
Phone verification is standard in Uzbekistan - everyone has a mobile, SMS is instant, and phone numbers are tied to ID cards (reduces fraud).

**Q: Can I skip email during signup?**
Yes, email is optional. The system uses phone for notifications if no email is provided.

**Q: How long are tokens valid?**
- Access Token: 15 minutes
- Refresh Token: 7 days

**Q: Can multiple employees share the same phone number?**
No. Each phone number can only be registered once.

---

## Related Documentation

| Document | Description |
|----------|-------------|
| [Admin Onboarding Wizard](./ADMIN_ONBOARDING_WIZARD.md) | Post-signup setup |
| [Admin Authentication](./ADMIN_AUTHENTICATION.md) | Full auth flow |
| [Admin PIN Management](./ADMIN_PIN_MANAGEMENT.md) | PIN system details |
