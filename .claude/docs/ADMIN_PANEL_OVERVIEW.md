# Admin Panel — Полный обзор для Frontend разработчиков

Этот документ предоставляет общее понимание Admin Panel системы OshLab: архитектуру, навигацию, роли пользователей, и связь между разделами. Используйте его как отправную точку перед углублением в специфические разделы.

---

## 📋 Содержание

1. [Введение в OshLab](#введение-в-oshlab)
2. [Архитектура системы](#архитектура-системы)
3. [Роли пользователей](#роли-пользователей)
4. [Структура Admin Panel](#структура-admin-panel)
5. [Базовые концепции](#базовые-концепции)
6. [Навигация и workflow](#навигация-и-workflow)
7. [API структура](#api-структура)
8. [Документация по разделам](#документация-по-разделам)

---

## Введение в OshLab

**OshLab** — это **white-label B2B2C платформа** для управления ресторанным бизнесом с мультитенантной архитектурой.

### 🎯 Что это значит?

**White-label:**
- Каждый клиент получает платформу со своим брендом
- Настраиваемый дизайн, логотипы, цвета
- Собственный домен (например: `pizza-house.oshlab.uz`)

**B2B2C:**
- **B2B** — продаём платформу ресторанам (наши клиенты)
- **B2C** — рестораны обслуживают своих клиентов через нашу платформу

**Мультитенант:**
- Один backend обслуживает множество ресторанов
- Полная изоляция данных между тенантами
- Масштабируемость и экономия ресурсов

### 🏗️ Основные компоненты платформы

```
┌────────────────────────────────────────────────────────┐
│                    OSHLAB PLATFORM                     │
├────────────────────────────────────────────────────────┤
│                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │   POS App    │  │ Admin Panel  │  │   WebApp    │ │
│  │  (Flutter)   │  │    (Web)     │  │  (Next.js)  │ │
│  │              │  │              │  │             │ │
│  │ Для кассиров │  │ Для менедж.  │  │ Для клиентов│ │
│  │ и официантов │  │ и владельцев │  │ ресторана   │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬──────┘ │
│         │                 │                  │        │
│         └─────────────────┼──────────────────┘        │
│                           │                           │
│                  ┌────────▼────────┐                  │
│                  │   Core API      │                  │
│                  │   (NestJS)      │                  │
│                  │                 │                  │
│                  │ - Multi-tenant  │                  │
│                  │ - DDD архитект. │                  │
│                  │ - PostgreSQL    │                  │
│                  └─────────────────┘                  │
│                                                        │
└────────────────────────────────────────────────────────┘
```

### 📱 Кто использует Admin Panel?

**Целевая аудитория:**
- 👨‍💼 **Владельцы ресторанов** — стратегические решения, аналитика
- 👩‍💼 **Менеджеры** — операционное управление, контроль персонала
- 👨‍🍳 **Управляющие** — меню, закупки, настройки филиалов

**Основные задачи:**
- Управление меню (категории, продукты, цены)
- Контроль персонала (графики, зарплаты, роли)
- Финансовый учёт (отчёты, кассы, выручка)
- Управление филиалами (настройки, конфигурации)
- Аналитика и отчёты (продажи, популярность блюд)

---

## Архитектура системы

### 🏛️ Domain-Driven Design (DDD)

Backend организован по **доменам** (бизнес-областям):

```
src/
├── domains/                    # Бизнес-логика (Domain Layer)
│   ├── tenant-management/      # Управление тенантами
│   ├── menu-management/        # Меню, продукты, категории
│   ├── order-management/       # Заказы, смены
│   ├── staff-management/       # Сотрудники, роли
│   ├── customer-management/    # Клиенты, лояльность
│   ├── branch-management/      # Филиалы, столы, залы
│   ├── financial-management/   # Платежи, отчёты
│   └── settings-management/    # Настройки системы
│
└── applications/               # API Layer (представление данных)
    ├── pos-api/                # Endpoints для POS
    ├── admin-api/              # Endpoints для Admin Panel ← ВЫ ЗДЕСЬ
    ├── webapp-api/             # Endpoints для клиентского приложения
    └── telegram-api/           # Endpoints для Telegram бота
```

### 🔐 Мультитенантность

**Каждая сущность привязана к `tenantId`:**

```typescript
// Пример: Product (продукт)
{
  id: 101,
  tenantId: 5,           // ← Ресторан "Пицца Хаус"
  name: "Маргарита",
  price: 890,
  ...
}
```

**Автоматическая изоляция:**
- Все запросы автоматически фильтруются по текущему тенанту
- Backend использует `AsyncLocalStorage` для контекста запроса
- Frontend не нужно вручную добавлять `tenantId` в каждый запрос

**Как это работает:**
```
1. Frontend делает запрос с JWT токеном
2. Backend извлекает tenantId из токена
3. Все SQL запросы автоматически добавляют WHERE tenantId = X
4. Данные других ресторанов недоступны
```

### 🌳 Структура филиалов

```
Tenant (Ресторан "Пицца Хаус")
  └── Branch (Филиал "Центр")
      ├── Halls (Залы)
      │   └── Tables (Столы)
      ├── Employees (Сотрудники)
      └── Settings (Настройки)

  └── Branch (Филиал "Спальный район")
      └── ...
```

**Branch Overrides:**
- Каждый филиал может переопределить настройки
- Цены на продукты могут отличаться
- Доступность блюд зависит от локации
- Настройки налогов, смен, касс — на уровне филиала

---

## Роли пользователей

### 👥 Иерархия ролей в Admin Panel

```
Owner (Владелец)
  ├── Полный доступ ко всему
  ├── Управление подписками и биллингом
  └── Создание новых менеджеров

Manager (Менеджер)
  ├── Управление меню и персоналом
  ├── Просмотр отчётов и аналитики
  ├── Настройки филиалов
  └── НЕТ доступа к биллингу

Supervisor (Управляющий)
  ├── Операционное управление одним филиалом
  ├── Контроль смен и персонала
  └── Базовая аналитика

Accountant (Бухгалтер)
  ├── Финансовые отчёты
  ├── Просмотр транзакций
  └── Только чтение (без редактирования)
```

### 🔒 Права доступа (PBAC)

**Permission-Based Access Control:**

| Раздел | Owner | Manager | Supervisor | Accountant |
|--------|-------|---------|------------|------------|
| Dashboard | ✅ Все | ✅ Все | ✅ Свой филиал | ✅ Финансы |
| Меню | ✅ Полный | ✅ Полный | ✅ Ограничено | ❌ Нет |
| Персонал | ✅ Полный | ✅ Полный | ✅ Свой филиал | ❌ Нет |
| Финансы | ✅ Полный | ✅ Просмотр | ✅ Свой филиал | ✅ Просмотр |
| Настройки | ✅ Полный | ✅ Базовые | ❌ Нет | ❌ Нет |
| Биллинг | ✅ Полный | ❌ Нет | ❌ Нет | ❌ Нет |

**Проверка прав на frontend:**
```typescript
// Пример проверки
if (user.hasPermission('menu:edit')) {
  // Показать кнопку "Редактировать"
}

if (user.hasRole('owner', 'manager')) {
  // Показать раздел "Аналитика"
}
```

---

## Структура Admin Panel

### 🗂️ Главное меню (Sidebar)

```
┌─────────────────────────────────────┐
│  🏠 Dashboard                       │  ← Главная страница с метриками
├─────────────────────────────────────┤
│  📊 Аналитика                       │  ← Графики, отчёты
│    ├── Продажи                      │
│    ├── Популярные блюда             │
│    └── Финансовые показатели        │
├─────────────────────────────────────┤
│  📋 Заказы                          │  ← История заказов
├─────────────────────────────────────┤
│  🍔 Меню                            │  ← Управление меню
│    ├── Категории                    │
│    ├── Продукты                     │
│    ├── Модификаторы                 │
│    ├── Дополнения                   │
│    ├── Шаблоны меню                 │
│    └── Настройки по филиалам        │
├─────────────────────────────────────┤
│  👥 Клиенты                         │  ← CRM
│    ├── База клиентов                │
│    ├── Программа лояльности         │
│    └── Отзывы                       │
├─────────────────────────────────────┤
│  👨‍💼 Персонал                        │  ← HR
│    ├── Сотрудники                   │
│    ├── Роли и права                 │
│    ├── График работы                │
│    └── Зарплаты                     │
├─────────────────────────────────────┤
│  🏪 Филиалы                         │  ← Управление локациями
│    ├── Список филиалов              │
│    ├── Залы и столы                 │
│    └── Настройки филиалов           │
├─────────────────────────────────────┤
│  💰 Финансы                         │  ← Бухгалтерия
│    ├── Кассовые смены               │
│    ├── Транзакции                   │
│    ├── Отчёты                       │
│    └── Выплаты                      │
├─────────────────────────────────────┤
│  ⚙️ Настройки                       │  ← Конфигурация
│    ├── Общие настройки              │
│    ├── Интеграции                   │
│    └── Налоги и печать              │
├─────────────────────────────────────┤
│  💳 Подписка                        │  ← Биллинг (только Owner)
└─────────────────────────────────────┘
```

### 📊 Dashboard (Главная страница)

**Ключевые метрики (KPI):**
```
┌──────────────────────────────────────────────────────┐
│  Сегодня                      Этот месяц             │
├──────────────────────────────────────────────────────┤
│  💰 Выручка: 1,250,000 ₽      15,890,000 ₽          │
│  📦 Заказов: 145              3,450                  │
│  👥 Клиентов: 98              1,890                  │
│  📈 Средний чек: 8,600 ₽      4,600 ₽               │
└──────────────────────────────────────────────────────┘
```

**Графики:**
- Динамика продаж (по дням/неделям/месяцам)
- Распределение продаж по категориям
- Популярность блюд (Top 10)
- Загруженность по часам

**Быстрые действия:**
- Создать новый продукт
- Добавить сотрудника
- Посмотреть активные смены
- Открыть отчёт за день

---

## Базовые концепции

### 🏢 Tenant (Тенант)

**Что это:**
Ресторан или сеть ресторанов, использующая платформу.

**Примеры:**
- "Пицца Хаус" — один ресторан
- "Кофе Тайм" — сеть из 5 кофеен
- "Суши Маркет" — франшиза из 15 точек

**Свойства:**
- Уникальный `tenantId`
- Собственная база клиентов
- Независимое меню
- Отдельный биллинг

### 🏪 Branch (Филиал)

**Что это:**
Физическая локация ресторана.

**Примеры:**
- "Пицца Хаус — Центр"
- "Пицца Хаус — ТЦ Мега"
- "Пицца Хаус — Аэропорт"

**Почему важно:**
- У филиалов могут быть разные цены
- Разное меню (сезонность, региональные блюда)
- Свой персонал
- Отдельная аналитика

### 🔄 Shift (Смена)

**Что это:**
Рабочая смена кассира/официанта в POS.

**Жизненный цикл:**
```
1. Открытие смены
   ├── Сотрудник открывает POS
   ├── Вводит начальную сумму в кассе (opening float)
   └── POST /pos/shifts

2. Работа в течение смены
   ├── Принимает заказы
   ├── Обрабатывает платежи
   └── Все транзакции привязаны к shiftId

3. Закрытие смены
   ├── Подсчёт наличности
   ├── Сверка с системой
   ├── Отчёт о расхождениях
   └── PATCH /pos/shifts/:id/close
```

**Для Admin Panel:**
- Просмотр всех смен
- Аналитика по сменам
- Контроль расхождений
- Отчёты по сотрудникам

### 💳 Payment (Платёж)

**Методы оплаты:**
- `cash` — Наличные
- `card` — Банковская карта
- `payme` — Payme
- `click` — Click
- `uzum` — Uzum Bank

**Split Payment (Разделение счёта):**
```
Пример: Счёт на 10,000₽, оплата пополам

Payment 1:
  ├── method: 'card'
  ├── amount: 5,000₽
  └── sequence: 1

Payment 2:
  ├── method: 'cash'
  ├── amount: 5,000₽
  └── sequence: 2
```

### 📝 Order (Заказ)

**Типы заказов:**
- `dine_in` — В зале (за столом)
- `takeaway` — На вынос
- `delivery` — Доставка

**Источники заказов:**
- `pos` — Создан в POS кассиром
- `web` — Через WebApp
- `telegram` — Через Telegram бота
- `aggregator` — С платформ доставки (Yandex.Eats)

**Статусы заказа:**
```
created (создан)
  ↓
paid (оплачен)
  ↓
preparing (готовится)
  ↓
ready (готов)
  ↓
delivered (доставлен)
  ↓
completed (завершён)
```

### 🎫 Receipt (Чек)

**Типы чеков:**
- `sale` — Продажа
- `refund` — Возврат
- `void` — Аннулирование

**Форматы:**
- `thermal` — Термопринтер (58мм, 80мм)
- `a4` — Лазерный принтер
- `email` — Электронный чек
- `sms` — Отправка в SMS

---

## Навигация и workflow

### 🎯 Типовые пользовательские сценарии

#### Сценарий 1: Утреннее открытие ресторана (Менеджер)

```
1. Вход в Admin Panel
   └── GET /auth/login

2. Dashboard — Проверка KPI за вчера
   └── GET /admin/analytics/dashboard

3. Проверка готовности к работе
   ├── Меню → Проверить доступность блюд
   │   └── GET /admin/menu/products?available=false
   ├── Персонал → Кто на смене сегодня
   │   └── GET /admin/staff/schedule?date=today
   └── Филиалы → Все ли столы свободны
       └── GET /admin/branches/:id/tables

4. Корректировка меню (если что-то недоступно)
   └── PATCH /admin/menu/products/:id/availability

5. Готовность к открытию ✅
```

#### Сценарий 2: Добавление нового блюда (Владелец/Менеджер)

```
1. Меню → Продукты → [+ Добавить]
   └── Открывается форма создания

2. Заполнение базовой информации
   ├── Название: "Салат Цезарь"
   ├── Категория: "Салаты"
   ├── Цена: 590₽
   └── POST /admin/menu/products

3. Добавление модификаторов
   ├── Группа "Размер порции"
   │   ├── Стандартная +0₽
   │   └── Большая +150₽
   └── POST /admin/menu/modifiers

4. Добавление дополнений
   ├── Группа "Соусы"
   │   ├── Цезарь (бесплатно)
   │   └── Чесночный +50₽
   └── POST /admin/menu/additions

5. Настройка по филиалам (опционально)
   └── PATCH /admin/menu/products/:id/branches/:branchId

6. Блюдо доступно в POS ✅
```

#### Сценарий 3: Еженедельный отчёт (Владелец)

```
1. Аналитика → Отчёты
   └── GET /admin/analytics/reports

2. Выбор периода
   └── Прошлая неделя (01.01 - 07.01)

3. Ключевые метрики
   ├── Общая выручка
   ├── Количество заказов
   ├── Средний чек
   └── Рост к предыдущей неделе

4. Детализация
   ├── По филиалам
   ├── По категориям
   └── По сотрудникам

5. Экспорт отчёта
   └── [Скачать PDF] / [Скачать Excel]
```

### 🔄 Связь между разделами

**Меню ↔ Заказы:**
```
Создали новое блюдо → Сразу доступно в POS → Клиент заказывает → Появляется в статистике
```

**Персонал ↔ Финансы:**
```
Добавили сотрудника → Назначили роль "Кассир" → Он открывает смену → Транзакции привязаны к нему → Отчёт по сотруднику
```

**Филиалы ↔ Меню:**
```
Создали филиал → Применили шаблон меню → Скорректировали цены для филиала → Филиал работает
```

---

## API структура

### 🔗 Base URL

```
Development: http://localhost:3000
Production:  https://api.oshlab.uz
```

### 🔑 Аутентификация

**Все запросы требуют JWT токен:**

```http
GET /admin/menu/products
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Получение токена:**
```http
POST /auth/login
Content-Type: application/json

{
  "phone": "+998901234567",
  "password": "secret123"
}

Response:
{
  "accessToken": "eyJhbG...",
  "refreshToken": "eyJhbG...",
  "user": {
    "id": 1,
    "tenantId": 5,
    "roles": ["owner"],
    "permissions": ["menu:edit", "staff:manage", ...]
  }
}
```

**Обновление токена:**
```http
POST /auth/refresh
Content-Type: application/json

{
  "refreshToken": "eyJhbG..."
}
```

### 📡 Формат ответов

**Успешный ответ:**
```json
{
  "id": 101,
  "name": "Капучино",
  "price": 350,
  "categoryId": 5,
  ...
}
```

**Список с пагинацией:**
```json
{
  "data": [...],
  "total": 156,
  "page": 1,
  "limit": 20,
  "totalPages": 8
}
```

**Ошибка валидации:**
```json
{
  "statusCode": 400,
  "message": [
    "name should not be empty",
    "price must be a number"
  ],
  "error": "Bad Request"
}
```

**Ошибка авторизации:**
```json
{
  "statusCode": 401,
  "message": "Unauthorized",
  "error": "Unauthorized"
}
```

**Ошибка прав доступа:**
```json
{
  "statusCode": 403,
  "message": "Insufficient permissions",
  "error": "Forbidden"
}
```

### 🗂️ Префиксы API

```
/admin/*          — Admin Panel endpoints
/pos/*            — POS Application endpoints
/webapp/*         — WebApp/Customer endpoints
/telegram/*       — Telegram Bot endpoints
/auth/*           — Authentication (общие для всех)
```

### 📚 Swagger документация

**Доступна по адресу:**
```
http://localhost:3000/api/docs
```

**Что там есть:**
- Полный список всех endpoints
- Описание параметров запросов
- Примеры ответов
- Try it out — тестирование API прямо в браузере
- Схемы валидации (DTOs)

---

## Документация по разделам

Детальная документация по каждому разделу:

### ✅ Готовые документы

1. **[Menu Management](./ADMIN_MENU_MANAGEMENT.md)** — Управление меню
   - Категории
   - Продукты
   - Модификаторы
   - Дополнения (Additions)
   - Шаблоны меню
   - Branch Overrides
   - **Статус:** API готово ✅, документация готова ✅

### 🚧 Документы в разработке

2. **Dashboard & Analytics** — Дашборд и аналитика
   - KPI метрики
   - Графики продаж
   - Популярные блюда
   - Финансовые показатели
   - **Статус:** API частично готово ⏳

3. **Staff Management** — Управление персоналом
   - Список сотрудников
   - Роли и права
   - Графики работы
   - Зарплаты и выплаты
   - **Статус:** API не готово ❌

4. **Branch Management** — Управление филиалами
   - Создание филиалов
   - Залы и столы
   - Настройки филиалов
   - **Статус:** API частично готово ⏳

5. **Customer Management** — Управление клиентами
   - База клиентов
   - Программа лояльности
   - История заказов
   - **Статус:** API частично готово ⏳

6. **Financial Management** — Финансовый учёт
   - Транзакции
   - Кассовые смены
   - Отчёты
   - Выплаты
   - **Статус:** API не готово ❌

7. **Settings** — Настройки системы
   - Общие настройки
   - Интеграции
   - Налоги и чеки
   - **Статус:** API частично готово ⏳

8. **Orders Management** — Управление заказами
   - История заказов
   - Детали заказов
   - Возвраты и отмены
   - **Статус:** API частично готово ⏳

---

## 🛠️ Технические требования

### Frontend стек (рекомендации)

**Framework:**
- React / Next.js (для SSR и SEO)
- TypeScript (строгая типизация)

**UI библиотеки:**
- Ant Design / Material-UI (готовые компоненты)
- TailwindCSS (кастомная стилизация)

**State Management:**
- Zustand / Redux Toolkit
- TanStack Query (React Query) для работы с API

**Графики:**
- Recharts / Chart.js
- ApexCharts (интерактивные графики)

**Формы:**
- React Hook Form
- Zod (валидация схем)

**Таблицы:**
- TanStack Table (React Table)
- AG Grid (для больших датасетов)

### Обязательные возможности

**Аутентификация:**
- Автоматический refresh токена
- Редирект на login при 401
- Сохранение токена в localStorage/cookies

**Обработка ошибок:**
- Toast уведомления
- Отображение ошибок валидации
- Retry механизм для failed requests

**UX:**
- Loading states (скелетоны)
- Оптимистичные обновления
- Debounce для поиска
- Infinite scroll / pagination

**Безопасность:**
- XSS защита
- CSRF токены
- Проверка прав на frontend (дублирует backend)

### Performance

**Оптимизации:**
- Lazy loading роутов
- Code splitting
- Мемоизация компонентов
- Виртуализация длинных списков

**Кэширование:**
- React Query cache
- LocalStorage для редко меняющихся данных
- Оптимистичные обновления

---

## 🎓 Обучающие материалы

### Полезные ссылки

**Документация:**
- [Swagger API Docs](http://localhost:3000/api/docs)
- [CLAUDE.md](../../CLAUDE.md) — Архитектура backend
- [DEVELOPMENT_ROADMAP.md](../../DEVELOPMENT_ROADMAP.md) — Roadmap проекта

**Для понимания бизнес-логики:**
- `.claude/project-description/` — Детальные описания доменов

**Примеры:**
- `docs/frontend/POS_WORKFLOW_NOW.md` — POS документация (аналог для POS)

### Термины и аббревиатуры

| Термин | Значение |
|--------|----------|
| **Tenant** | Ресторан, использующий платформу |
| **Branch** | Филиал ресторана |
| **Override** | Переопределение настроек на уровне филиала |
| **Shift** | Рабочая смена кассира |
| **DDD** | Domain-Driven Design |
| **PBAC** | Permission-Based Access Control |
| **DTO** | Data Transfer Object (объект для передачи данных) |
| **KPI** | Key Performance Indicator (ключевой показатель) |

---

## 🚀 С чего начать?

### Шаг 1: Изучите документацию

1. Прочитайте этот документ полностью
2. Ознакомьтесь с [ADMIN_MENU_MANAGEMENT.md](./ADMIN_MENU_MANAGEMENT.md)
3. Откройте Swagger docs и изучите API

### Шаг 2: Настройте окружение

1. Получите доступ к API (dev/staging)
2. Настройте API client (axios/fetch)
3. Реализуйте аутентификацию

### Шаг 3: Начните с простого

1. Создайте Login страницу
2. Реализуйте Dashboard (базовые метрики)
3. Постройте список продуктов (Menu → Products)

### Шаг 4: Итеративная разработка

1. Реализуйте один раздел полностью
2. Протестируйте с реальными данными
3. Соберите фидбек
4. Переходите к следующему разделу

---

## 📞 Контакты и поддержка

**Вопросы по API:**
- Slack: `#admin-panel-api`
- Backend team lead

**Вопросы по бизнес-логике:**
- Slack: `#product-team`
- Product manager

**Баги и предложения:**
- GitHub Issues
- Jira (если используется)

---

**Версия документа:** 1.0
**Дата создания:** 2025-01-24
**Следующее обновление:** После реализации Dashboard API

**Авторы:** Backend Team
**Для:** Frontend Team (Admin Panel)
