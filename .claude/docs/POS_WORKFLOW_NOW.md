# POS — функционал, доступный к немедленной интеграции

Документ перечисляет фронтенд-задачи, которые уже можно реализовать на текущем UI POS, потому что для них существует готовый API. Материал опирается на макеты кассового цикла и синхронизирован со стадией «Stage 2: POS API - Cashier/Waiter Workflow» из `DEVELOPMENT_ROADMAP.md`. Для каждой страницы зафиксированы назначение, обязательные данные, проверочные шаги и сервисный контекст, чтобы разработчик понимал роль объектов вроде `sessionId`.

## Базовые принципы
- **Контекст приложения.** После логина сохраняем `tenantId`, `branchId`, `employeeId` и `roles`, которые приходят вместе с токенами. Эти значения нужны почти в каждом POS-запросе. Если открыт стол, добавляем `tableSessionId` — идентификатор активной сессии.
- **Смена и касса.** Перед операциями с заказами кассир должен открыть смену (`POST /pos/shifts`) и кассовую сессию (`POST /pos/finance/sessions/open`). Из ответов сохраняем `shiftId` и `cashSessionId`.
- **Сессия стола.** `tableSessionId` создаётся при посадке гостей (`POST /pos/tables/:id/start-session`) и закрывается при завершении (`POST /pos/tables/:id/end-session`). Этим идентификатором связываем заказы, оплаты и отчёты.
- **JWT и PIN.** Все POS-вызовы выполняются с JWT, полученным через телефон+пароль (`POST /auth/login`) или быстрый вход (`POST /auth/pin-login`). Для автообновления используется `POST /auth/refresh`, а `GET /auth/me` возвращает актуальный контекст.

## 1. Экран входа (телефон + пароль)
- **Цель:** базовая аутентификация сотрудника.
- **API:** `POST /auth/login`, `POST /auth/refresh`, `GET /auth/me`.
- **Фронтенд-задачи:**
  - Реализовать форму с валидацией номера телефона и пароля.
  - Сохранять `accessToken`, `refreshToken`, `employeeId`, `tenantId`, `roles`, `activeBranchId` в сторе.
  - Настроить автоматический `refresh` при истечении токена и запрос `GET /auth/me` после обновления.
- **Проверка:** при успешном ответе отображать имя сотрудника и проверять флаг, требуется ли PIN (поле `requiresPin`).

## 2. Экран выбора сотрудника
- **Цель:** дать возможность менеджеру выбрать сотрудника филиала перед вводом PIN.
- **API:** `GET /pos/auth/staff-list?branchId=...` — возвращает сотрудников с полями `isOnShift`, `lastActiveAt`, `roles`.
- **Фронтенд-задачи:**
  - Отрисовать карусель аватаров с именем, ролью и статусом смены.
  - По клику сохранять `selectedEmployeeId` и переходить на экран PIN.
  - Подсветить сотрудников в активной смене (`isOnShift=true`) и отображать время последнего входа.
- **Проверка:** убедиться, что карусель фильтрует неактивных сотрудников (`isActive=false`).

## 3. Ввод PIN-кода
- **Цель:** обеспечить быстрый вход без повторного ввода пароля.
- **API:** `POST /auth/pin-login`.
- **Фронтенд-задачи:**
  - Реализовать цифровую клавиатуру, ограничить длину PIN (4–6 символов).
  - Сохранять выбранного сотрудника и передавать `employeeId` + PIN в запрос.
  - По успешному ответу обновлять токены и активный филиал (`activeBranchId`).
- **Проверка:** если API возвращает флаг `shiftActive=false`, перенаправлять на модалку открытия смены.

## 4. Открытие или продолжение смены
- **Цель:** подготовить кассу и закрепить сотрудника за сменой.
- **API:**
  - `GET /pos/shifts` — проверка активных смен пользователя. [F:docs/services/pos-api/openapi.yaml†L998-L1032]
  - `POST /pos/shifts` — открытие смены, ответ содержит `id`, `branchId`, `openedAt`, `openingFloat`. [F:docs/services/pos-api/openapi.yaml†L998-L1032]
  - `POST /pos/finance/sessions/open` — открытие кассы, возвращает `sessionId` (используем как `cashSessionId`). [F:docs/services/pos-api/openapi.yaml†L938-L957]
- **Фронтенд-задачи:**
  - Показать модалку со вводом стартовой суммы (`openingFloat`).
  - Сохранить `shiftId` и `cashSessionId` в сторе.
  - Предусмотреть выбор «Продолжить» для уже открытой смены (используем данные `GET /pos/shifts`).
- **Проверка:** не пускать пользователя на карту столов, если смена или кассовая сессия не открыта.

## 5. Главная (категории и карточки меню)
- **Цель:** показать актуальное меню с фильтрами и поиском.
- **API:**
  - `GET /pos/menu` — дерево категорий и продуктов.
  - `GET /pos/menu/search?q=` — поиск по названию или тегу.
  - `GET /pos/menu/products/{productId}` — подробности, модификаторы, цены.
- **Фронтенд-задачи:**
  - Кешировать меню и предоставлять быстрые фильтры (категории, теги, поиск).
  - Показывать бейджи «Хит», «Нет в наличии» на основании полей `tags` и `stockLevel`.
  - Обрабатывать событие выбора продукта и открывать модалку добавления заказа.
- **Проверка:** при переключении филиала очищать кеш и перезагружать меню с новым `branchId`.

## 6. Модальное окно «Добавить заказ»
- **Цель:** собрать состав заказа с модификаторами и комментариями.
- **API:**
  - `POST /pos/orders` — создание заказа (поля: `tableSessionId`, `items`, `notes`).
  - `GET /pos/orders/{orderId}` — получение актуального состояния заказа.
  - `POST /pos/orders/{orderId}/items` — добавление позиций к существующему заказу.
- **Фронтенд-задачи:**
  - Формировать структуру `items` (`productId`, `quantity`, `unitPrice`, `modifiers`, `notes`).
  - Для допродаж использовать `POST /pos/orders/{orderId}/items` вместо пересоздания заказа.
  - Сохранять `orderId` и статус (`IN_PROGRESS`, `READY_FOR_PAYMENT`).
- **Проверка:** удостовериться, что в каждом запросе передаётся `tableSessionId`, иначе заказ останется «без стола».

## 7. Добавление заметок
- **Цель:** фиксировать комментарии по заказу.
- **API:**
  - `POST /pos/orders` или `POST /pos/orders/{orderId}/items` — поле `notes` для позиции.
  - `PATCH /pos/orders/{orderId}/note` — общий комментарий заказа.
  - `PATCH /pos/orders/{orderId}` — обновление статуса заказа.
- **Фронтенд-задачи:**
  - Предоставить поле ввода заметки как при создании заказа, так и для отдельных позиций.
  - При изменении общего комментария отправлять `PATCH /pos/orders/{orderId}/note` с полем `note`.
- **Проверка:** отображать заметку в списке заказов и в печатных документах.

## 8. Карта залов и управление столами
- **Цель:** визуализировать расположение столов и статусы.
- **API:**
  - `GET /pos/tables?branchId=` — список столов филиала с активными сессиями.
  - `GET /pos/tables/:id/status` — подробности стола с текущей сессией и заказами.
  - `POST /pos/tables/:id/start-session` / `POST /pos/tables/:id/end-session` — управление посадкой.
- **Фронтенд-задачи:**
  - Отрисовать столы по координатам (`positionX`, `positionY`, `rotation`).
  - Поддержать операции открытия/закрытия стола, указание количества гостей, назначение официанта.
  - При создании сессии сохранять `tableSessionId` в контексте активного заказа.
- **Проверка:** при завершении сессии очищать заказы и статусы, связанные с этим `tableSessionId`.

## 9. Мониторинг активных заказов
- **Цель:** отобразить все незакрытые заказы по столам.
- **API:** `GET /pos/orders?status=IN_PROGRESS` (или другой статус).
- **Фронтенд-задачи:**
  - Группировать заказы по столам и показывать время ожидания (`createdAt`).
  - Добавить быстрые действия: «Перейти к оплате», «Изменить заказ», «Закрыть стол».
- **Проверка:** при оплате обновлять список, чтобы заказ исчезал после перехода в статус `PAID`.

## 10. Калькулятор оплаты
- **Цель:** принять оплату, учесть чаевые и рассчитать сдачу.
- **API:**
  - `POST /pos/finance/payments` — создание платежа, ответ содержит `paymentId`, `remainingAmount`, `changeAmount`.
  - `POST /pos/finance/payments/{paymentId}/complete` — подтверждение транзакции.
  - `POST /pos/finance/payments/{paymentId}/refund` — возврат платежа.
- **Фронтенд-задачи:**
  - Реализовать ввод сумм по каналам (наличные, карта, чаевые) и отображать сдачу из поля `changeAmount`.
  - Сохранять `paymentId` до подтверждения, чтобы повторно отправить `complete` при сетевых сбоях.
  - После успешного `complete` обновлять заказ `PATCH /pos/orders/{orderId}` → `PAID`.
- **Проверка:** сверять итоговую сумму в UI с `remainingAmount` — она должна стать 0 после подтверждения.

## 11. Закрытие смены
- **Цель:** корректно завершить рабочий день.
- **API:**
  - `POST /pos/finance/sessions/{sessionId}/close` — закрытие кассы, возвращает итоговый отчёт.
  - `POST /pos/shifts/{shiftId}/close` — закрытие смены сотрудника.
- **Фронтенд-задачи:**
  - Показать сводку по наличным и безналичным платежам, собранным за смену.
  - После закрытия кассы запрещать операции с заказами, пока не открыта новая смена.
- **Проверка:** проверять, что API возвращает статус `200` и сохранять итоговые данные для отчётности.

## Что ещё подключить прямо сейчас
Все пункты ниже имеют готовый API и могут быть реализованы параллельно:
- **Изменение статуса заказа:** `PATCH /pos/orders/{orderId}` — перевести заказ в `READY_FOR_PAYMENT` или `PAID`.
- **Удаление позиций:** `DELETE /pos/orders/{orderId}/items/{itemId}` — убрать блюдо из заказа.
- **Перенос/слияние столов:** `PATCH /pos/tables/:id/session` — обновить гостевой состав, сервер или заметку активной сессии.
- **Возврат платежа:** `POST /pos/finance/payments/{paymentId}/refund` — оформить возврат из экрана истории заказов.

Эта инструкция помогает фронтенд-разработчику сопоставить текущие экраны POS с готовыми сервисами и минимизировать блокеры при интеграции.
