# Бизнес-логика: Расчёт себестоимости

> WAC, Hybrid Costing, Profit Calculation

---

## Обзор

```
+-------------------------------------------------------------------------+
|                    МОДЕЛИ СЕБЕСТОИМОСТИ                                  |
+-------------------------------------------------------------------------+
|                                                                          |
|  1. WAC (Weighted Average Cost)                                          |
|     Для сырья (InventoryItems)                                           |
|     Пересчитывается при каждой закупке                                   |
|                                                                          |
|  2. Recipe Cost                                                          |
|     Для продуктов меню                                                   |
|     = SUM(ингредиенты * WAC * (1 + waste))                               |
|                                                                          |
|  3. Direct Cost                                                          |
|     Для покупных товаров без рецепта                                     |
|     = Последняя закупочная цена                                          |
|                                                                          |
|  4. Manual Cost                                                          |
|     Заданная вручную                                                     |
|     Для товаров без закупок                                              |
|                                                                          |
+-------------------------------------------------------------------------+
```

---

## 1. WAC (Weighted Average Cost)

### Что это

Средневзвешенная себестоимость единицы товара. Пересчитывается при каждом поступлении.

### Формула

```
Новый WAC = (Текущий остаток * Текущий WAC + Новое количество * Новая цена)
            / (Текущий остаток + Новое количество)
```

### Пример расчёта

```
+---------------------------------------------------------------------+
|  ПРИМЕР: Закупка томатов                                             |
+---------------------------------------------------------------------+
|                                                                      |
|  ДО ЗАКУПКИ:                                                         |
|  +----------------------------------------------------------------+  |
|  | Остаток:    10 кг                                              |  |
|  | WAC:        80,000 сум/кг                                      |  |
|  | Стоимость:  800,000 сум                                        |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
|  ЗАКУПКА:                                                            |
|  +----------------------------------------------------------------+  |
|  | Получено:   20 кг                                              |  |
|  | Цена:       90,000 сум/кг                                      |  |
|  | Стоимость:  1,800,000 сум                                      |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
|  РАСЧЁТ:                                                             |
|  +----------------------------------------------------------------+  |
|  | newTotalValue = 800,000 + 1,800,000 = 2,600,000                |  |
|  | newQuantity   = 10 + 20 = 30                                   |  |
|  | newWAC        = 2,600,000 / 30 = 86,666.67 сум/кг              |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
|  ПОСЛЕ ЗАКУПКИ:                                                      |
|  +----------------------------------------------------------------+  |
|  | Остаток:    30 кг                                              |  |
|  | WAC:        86,666.67 сум/кг                                   |  |
|  | lastCost:   90,000 сум/кг (последняя закупка)                  |  |
|  | Стоимость:  2,600,000 сум                                      |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
+---------------------------------------------------------------------+
```

### Когда WAC меняется

| Операция | WAC меняется? |
|----------|---------------|
| Приёмка закупки (PURCHASE_RECEIVE) | Да, пересчёт |
| Продажа (SALE_DEDUCTION) | Нет |
| Списание (WRITEOFF) | Нет |
| Корректировка количества | Нет |
| Корректировка себестоимости | Да, если явно указано |
| Возврат от клиента | Нет (используется старый WAC) |
| Отмена заказа (SALE_REVERSAL) | Нет |

### UI отображение WAC

```
+--------------------------------------------------+
|  Stock Details: Tomatoes                          |
+--------------------------------------------------+
|                                                   |
|  Average Cost (WAC):    86,667 UZS/kg             |
|  Last Purchase Cost:    90,000 UZS/kg             |
|  Cost Trend:            [arrow up] +5%            |
|                                                   |
+--------------------------------------------------+
```

---

## 2. Recipe Cost (Себестоимость рецепта)

### Формула

```
recipeCost = SUM(ingredient.quantity * (1 + ingredient.wasteFactor) * item.avgCost)
costPerUnit = recipeCost / outputQuantity
```

### Пример расчёта

```
+---------------------------------------------------------------------+
|  РЕЦЕПТ: Бургер Классик (1 порция)                                   |
+---------------------------------------------------------------------+
|                                                                      |
|  Ингредиенты:                                                        |
|  +----------------------------------------------------------------+  |
|  | Ингредиент  | Кол-во | Waste | Эффект. | WAC    | Стоимость   |  |
|  +----------------------------------------------------------------+  |
|  | Говядина    | 0.15   | 10%   | 0.165   | 85,000 | 14,025      |  |
|  | Булочка     | 1      | 0%    | 1       | 3,000  | 3,000       |  |
|  | Сыр         | 0.05   | 5%    | 0.0525  | 95,000 | 4,988       |  |
|  | Соус        | 0.02   | 0%    | 0.02    | 45,000 | 900         |  |
|  | Овощи       | 0.03   | 15%   | 0.0345  | 12,000 | 414         |  |
|  +----------------------------------------------------------------+  |
|  | ИТОГО       |        |       |         |        | 23,327      |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
|  costPerUnit = 23,327 / 1 = 23,327 UZS                               |
|                                                                      |
+---------------------------------------------------------------------+
```

### Кэширование

```
Recipe Entity:
+-------------------------+
| calculatedCost: 23,327  |  <- Кэшированная себестоимость
| costUpdatedAt: Jan 18   |  <- Когда пересчитано
+-------------------------+

Стратегии обновления:
1. При сохранении рецепта
2. При изменении WAC ингредиента (если autoUpdateCost=true)
3. По cron каждые 24 часа
4. Вручную (кнопка Recalculate)
```

### UI: Сравнение с ценой продажи

```
+--------------------------------------------------+
|  Cost Analysis: Classic Burger                    |
+--------------------------------------------------+
|                                                   |
|  Recipe Cost:       23,327 UZS                    |
|  Selling Price:     45,000 UZS                    |
|  -----------------------------------------        |
|  Gross Profit:      21,673 UZS                    |
|  Margin:            48.2%                         |
|                                                   |
|  [!] Target margin: 50%                           |
|      Recommended price: 46,654 UZS                |
|                                                   |
+--------------------------------------------------+
```

---

## 3. Себестоимость при продаже

### Flow: Заказ -> Списание -> Фиксация себестоимости

```
+---------------------------------------------------------------------+
|  ЗАКАЗ ЗАВЕРШЁН                                                      |
+---------------------------------------------------------------------+
|                                                                      |
|  Order:                                                              |
|  +----------------------------------------------------------------+  |
|  | Item: Classic Burger x 2                                       |  |
|  | Price: 45,000 x 2 = 90,000 UZS                                 |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
|          |                                                           |
|          v                                                           |
|                                                                      |
|  StockDeduction (асинхронно):                                        |
|  +----------------------------------------------------------------+  |
|  | Говядина: -0.33 кг @ WAC 85,000 = -28,050 UZS                  |  |
|  | Булочка:  -2 шт @ WAC 3,000 = -6,000 UZS                       |  |
|  | Сыр:      -0.105 кг @ WAC 95,000 = -9,975 UZS                  |  |
|  | ...                                                            |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
|  StockMovements записаны с unitCost = текущий WAC                    |
|                                                                      |
|  Расчёт прибыли:                                                     |
|  +----------------------------------------------------------------+  |
|  | Revenue:    90,000 UZS                                         |  |
|  | COGS:       46,654 UZS (SUM movements.totalCost)               |  |
|  | Profit:     43,346 UZS (48.2%)                                 |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
+---------------------------------------------------------------------+
```

### Получение себестоимости заказа

```
Способ 1: Через StockMovements
SELECT SUM(total_cost)
FROM im_stock_movements
WHERE reference_type = 'order'
  AND reference_id = :orderId
  AND movement_type = 'SALE_DEDUCTION'

Способ 2: Через Recipe (оценка)
SELECT SUM(r.calculated_cost * oi.quantity)
FROM om_order_items oi
JOIN im_recipes r ON r.product_id = oi.product_id
WHERE oi.order_id = :orderId
```

---

## 4. Profit Snapshot

### Когда фиксировать себестоимость

```
+---------------------------------------------------------------------+
|  ВАРИАНТЫ СНИМКА СЕБЕСТОИМОСТИ                                       |
+---------------------------------------------------------------------+
|                                                                      |
|  1. При создании заказа (order creation)                             |
|     + Точная на момент заказа                                        |
|     - Сложнее implementation                                         |
|                                                                      |
|  2. При завершении заказа (order completion)   <- ТЕКУЩИЙ ПОДХОД     |
|     + Реальная себестоимость списания                                |
|     + Простая реализация через movements                             |
|                                                                      |
|  3. Ретроспективно (для отчётов)                                     |
|     + Гибко                                                          |
|     - Медленно для больших объёмов                                   |
|                                                                      |
+---------------------------------------------------------------------+
```

### UI: Отчёт о прибыльности

```
+--------------------------------------------------+
|  Profitability Report                             |
|  Period: Jan 1-18, 2026                           |
+--------------------------------------------------+
|                                                   |
|  Total Revenue:     12,500,000 UZS                |
|  Total COGS:         6,437,000 UZS                |
|  Gross Profit:       6,063,000 UZS                |
|  Margin:             48.5%                        |
|                                                   |
|  Top Products by Margin:                          |
|  +-----------------------------------------------+|
|  | Product           | Sales   | Margin          ||
|  +-----------------------------------------------+|
|  | Margherita Pizza  | 2.1M    | 52.3%           ||
|  | Caesar Salad      | 890k    | 51.8%           ||
|  | Classic Burger    | 1.5M    | 48.2%           ||
|  +-----------------------------------------------+|
|                                                   |
|  Low Margin Alert:                                |
|  +-----------------------------------------------+|
|  | [!] Steak Dinner    | 28.5%  | Consider price ||
|  +-----------------------------------------------+|
|                                                   |
+--------------------------------------------------+
```

---

## 5. Cost Types для Product

```
+---------------------------------------------------------------------+
|  ТИПЫ СЕБЕСТОИМОСТИ ПРОДУКТА                                         |
+---------------------------------------------------------------------+
|                                                                      |
|  Product.costType: 'recipe' | 'direct' | 'manual' | 'none'           |
|                                                                      |
|  +----------------------------------------------------------------+  |
|  | Type      | Источник              | Пример                    |  |
|  +----------------------------------------------------------------+  |
|  | recipe    | Recipe.calculatedCost | Бургер, Пицца             |  |
|  | direct    | PurchaseOrder price   | Напитки в бутылках        |  |
|  | manual    | Product.manualCost    | Услуги, доставка          |  |
|  | none      | Не отслеживается      | Временные товары          |  |
|  +----------------------------------------------------------------+  |
|                                                                      |
+---------------------------------------------------------------------+
```

### UI: Настройка типа себестоимости

```
+--------------------------------------------------+
|  Product: Coca-Cola 0.5L                          |
+--------------------------------------------------+
|                                                   |
|  Cost Tracking:                                   |
|  +-----------------------------------------------+|
|  | ( ) Recipe-based  (calculate from ingredients)||
|  | (*) Direct cost   (purchase price)            ||
|  | ( ) Manual cost   (enter fixed amount)        ||
|  | ( ) Don't track                               ||
|  +-----------------------------------------------+|
|                                                   |
|  IF direct:                                       |
|  +-----------------------------------------------+|
|  | Last purchase: 8,500 UZS (Jan 15)             ||
|  | Avg purchase:  8,200 UZS                      ||
|  +-----------------------------------------------+|
|                                                   |
|  IF manual:                                       |
|  +-----------------------------------------------+|
|  | Cost: [          ] UZS                        ||
|  +-----------------------------------------------+|
|                                                   |
+--------------------------------------------------+
```

---

## 6. Формулы для UI

### Food Cost Percentage

```
foodCostPercent = (recipeCost / sellingPrice) * 100

Пример:
foodCostPercent = (23,327 / 45,000) * 100 = 51.8%
```

### Gross Margin

```
grossMargin = sellingPrice - recipeCost
marginPercent = (grossMargin / sellingPrice) * 100

Пример:
grossMargin = 45,000 - 23,327 = 21,673
marginPercent = (21,673 / 45,000) * 100 = 48.2%
```

### Suggested Price (target margin)

```
suggestedPrice = recipeCost / (1 - targetMargin)

Пример (target 50%):
suggestedPrice = 23,327 / (1 - 0.50) = 46,654 UZS
```

### Cost Change Alert

```
costChangePercent = ((newCost - oldCost) / oldCost) * 100

IF costChangePercent > 5% THEN
  показать warning
IF costChangePercent > 10% THEN
  показать alert
```

---

## 7. API Endpoints

### GET /admin/products/:id/cost-analysis

```json
// Response 200
{
  "productId": 100,
  "productName": "Classic Burger",
  "sellingPrice": 45000,
  "costType": "recipe",
  "recipeCost": 23327,
  "directCost": null,
  "manualCost": null,
  "effectiveCost": 23327,
  "grossMargin": 21673,
  "marginPercent": 48.2,
  "foodCostPercent": 51.8,
  "suggestedPrice": 46654,
  "costHistory": [
    {"date": "2026-01-18", "cost": 23327},
    {"date": "2026-01-11", "cost": 22500},
    {"date": "2026-01-04", "cost": 22500}
  ],
  "lastUpdated": "2026-01-18T10:00:00Z"
}
```

### GET /admin/reports/profitability

```json
// Query: ?from=2026-01-01&to=2026-01-18
// Response 200
{
  "period": {"from": "2026-01-01", "to": "2026-01-18"},
  "summary": {
    "totalRevenue": 12500000,
    "totalCOGS": 6437000,
    "grossProfit": 6063000,
    "marginPercent": 48.5
  },
  "byProduct": [
    {
      "productId": 100,
      "productName": "Classic Burger",
      "quantitySold": 150,
      "revenue": 6750000,
      "cogs": 3499050,
      "profit": 3250950,
      "marginPercent": 48.2
    }
  ],
  "lowMarginAlerts": [
    {
      "productId": 200,
      "productName": "Steak Dinner",
      "marginPercent": 28.5,
      "recommendation": "Consider price increase"
    }
  ]
}
```

---

## FAQ

**Q: Почему WAC, а не FIFO?**

A: WAC проще в реализации и достаточен для ресторанного бизнеса. FIFO требует batch tracking.

**Q: Когда пересчитывается себестоимость рецепта?**

A: При изменении рецепта, при изменении WAC ингредиентов (если autoUpdate), по cron каждые 24 часа.

**Q: Как посчитать прибыль за период?**

A: Суммировать StockMovements с типом SALE_DEDUCTION и referenceType=order за период.

**Q: Что если у товара нет рецепта?**

A: Используется costType=direct (последняя закупочная цена) или manual.

---

*Документ актуален на январь 2026*
